# CYP-memo 开发模式 Dockerfile
# 支持热重载和调试功能

FROM node:18-alpine

# 配置 Alpine 镜像源（阿里云 - 速度最快 108ms）
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# 安装 pnpm (华为云镜像)
RUN npm config set registry https://repo.huaweicloud.com/repository/npm/ && \
    npm install -g pnpm && \
    pnpm config set registry https://repo.huaweicloud.com/repository/npm/

# 创建工作目录
WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/app/package.json ./packages/app/
COPY packages/admin/package.json ./packages/admin/
COPY packages/server/package.json ./packages/server/

# 安装全部依赖（包括开发依赖）
# 增加网络超时和重试以提高稳定性
RUN pnpm config set network-timeout 60000 && \
    pnpm config set fetch-retries 5 && \
    pnpm config set fetch-retry-mintimeout 20000 && \
    pnpm install --frozen-lockfile

# 复制源代码（开发模式下会被挂载覆盖）
COPY . .

# 创建数据目录
RUN mkdir -p /app/data

# 环境变量
# NODE_OPTIONS: 增加内存限制，加速构建
# UV_THREADPOOL_SIZE: 增加线程池，加速 I/O
ENV NODE_ENV=development \
    PORT=5170 \
    DATA_DIR=/app/data \
    LOG_LEVEL=debug \
    NODE_OPTIONS="--max-old-space-size=4096" \
    UV_THREADPOOL_SIZE=16

# 暴露端口
# 5170: 应用端口
# 9229: Node.js 调试端口
EXPOSE 5170 9229

# 设置工作目录到服务器包
WORKDIR /app

# 默认命令：启动开发服务器（支持热重载）
CMD ["pnpm", "dev:server"]
