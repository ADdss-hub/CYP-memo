# CYP-memo 开发模式 Docker Compose 配置
# 支持源码挂载、热重载和调试功能

version: '3.8'

services:
  cyp-memo-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    image: cyp-memo:dev
    container_name: cyp-memo-dev
    ports:
      # 后端 API 端口
      - "5170:5170"
      # 用户端前端端口
      - "5173:5173"
      # 管理端前端端口
      - "5174:5174"
      # Node.js 调试端口
      - "9229:9229"
    volumes:
      # 源码挂载 - 支持热重载
      - ../packages:/app/packages
      - ../package.json:/app/package.json
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ../scripts:/app/scripts
      # 数据持久化
      - cyp-memo-dev-data:/app/data
      # 排除 node_modules（使用容器内的依赖）
      - /app/node_modules
      - /app/packages/server/node_modules
      - /app/packages/app/node_modules
      - /app/packages/admin/node_modules
      - /app/packages/shared/node_modules
    environment:
      - NODE_ENV=development
      - PORT=5170
      - DATA_DIR=/app/data
      - LOG_LEVEL=debug
      - TZ=Asia/Shanghai
      # Vite 需要监听所有接口才能从容器外访问
      - VITE_HOST=0.0.0.0
    restart: unless-stopped
    # 同时运行后端和前端
    command: pnpm dev:all
    networks:
      - cyp-memo-dev-network
    # 开发模式下的健康检查（更宽松的配置）
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5170/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  cyp-memo-dev-network:
    driver: bridge

volumes:
  cyp-memo-dev-data:
    driver: local
