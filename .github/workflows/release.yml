name: Release All Platforms

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发，如 v1.7.10
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to GitHub Releases'
        required: true
        default: 'true'
        type: boolean

# 添加必要的权限
permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20.19.6'
  PNPM_VERSION: '10.11.0'

jobs:
  # ========== 构建 Web 端和管理端 ==========
  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache pnpm & native builds
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Configure npm registry (优先华为云镜像加速)
        run: |
          # 测试华为云镜像可用性
          if curl -s --connect-timeout 5 --max-time 10 "https://repo.huaweicloud.com/repository/npm/-/ping" > /dev/null 2>&1; then
            echo "Huawei mirror available, using it"
            npm config set registry https://repo.huaweicloud.com/repository/npm/
            pnpm config set registry https://repo.huaweicloud.com/repository/npm/
          else
            echo "Huawei mirror unavailable, fallback to official"
            npm config set registry https://registry.npmjs.org/
            pnpm config set registry https://registry.npmjs.org/
          fi

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build web app
        run: pnpm --filter @cyp-memo/app build

      - name: Build admin app
        run: pnpm --filter @cyp-memo/admin build

      - name: Package web artifacts
        run: |
          mkdir -p artifacts
          cd packages/app && zip -r ../../artifacts/cyp-memo-web-${{ github.ref_name }}.zip dist
          cd ../admin && zip -r ../../artifacts/cyp-memo-admin-${{ github.ref_name }}.zip dist

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-artifacts
          path: artifacts/*.zip

  # ========== 构建桌面端 (Windows) ==========
  build-desktop-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache pnpm & native builds
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
            ~/AppData/Local/node-gyp
            ~/AppData/Local/electron
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-pnpm-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-electron-
            ${{ runner.os }}-pnpm-

      - name: Configure npm registry (优先华为云镜像，验证预构建二进制)
        shell: pwsh
        run: |
          # 验证预构建二进制文件是否有效 (检查 gzip 头)
          function Test-Prebuild {
            param($url)
            try {
              $response = Invoke-WebRequest -Uri $url -TimeoutSec 10 -UseBasicParsing -ErrorAction Stop
              $bytes = $response.Content[0..1]
              # gzip 文件头: 0x1f 0x8b
              if ($bytes[0] -eq 0x1f -and $bytes[1] -eq 0x8b) {
                return $true
              }
              return $false
            } catch {
              return $false
            }
          }
          
          # 验证华为云 better-sqlite3 预构建二进制
          $huaweiPrebuildValid = Test-Prebuild "https://repo.huaweicloud.com/better-sqlite3/v9.6.0/better-sqlite3-v9.6.0-electron-v119-win32-x64.tar.gz"
          Write-Host "Huawei prebuild valid: $huaweiPrebuildValid"
          
          if ($huaweiPrebuildValid) {
            Write-Host "Using Huawei mirror (prebuild valid)"
            npm config set registry https://repo.huaweicloud.com/repository/npm/
            pnpm config set registry https://repo.huaweicloud.com/repository/npm/
            "ELECTRON_MIRROR=https://repo.huaweicloud.com/electron/" | Out-File -FilePath $env:GITHUB_ENV -Append
            "ELECTRON_BUILDER_BINARIES_MIRROR=https://repo.huaweicloud.com/electron-builder-binaries/" | Out-File -FilePath $env:GITHUB_ENV -Append
          } else {
            Write-Host "Huawei prebuild invalid, fallback to official npm registry"
            npm config set registry https://registry.npmjs.org/
            pnpm config set registry https://registry.npmjs.org/
          }

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          npm_config_build_from_source: false

      - name: Build shared package
        run: pnpm --filter @cyp-memo/shared build || echo "Shared package has no build script, skipping"

      - name: Generate placeholder icons
        run: node scripts/create-placeholder-icons.mjs
        working-directory: packages/desktop

      - name: Build desktop app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_force: true
        run: pnpm --filter @cyp-memo/desktop build:win -- --publish never
        shell: pwsh

      - name: List build output
        run: |
          Get-ChildItem -Path packages/desktop/release -Recurse | Format-Table Name, Length
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          path: |
            packages/desktop/release/**/*.exe
            packages/desktop/release/**/latest.yml

  # ========== 构建桌面端 (macOS) ==========
  build-desktop-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for node-gyp
        run: |
          python3 -m pip install setuptools --break-system-packages
          echo "GYP_PYTHON_EXCLUDE=1" >> $GITHUB_ENV

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Cache pnpm & native builds
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
            ~/Library/Caches/node-gyp
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-pnpm-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-electron-
            ${{ runner.os }}-pnpm-

      - name: Configure npm registry (优先华为云镜像，验证预构建二进制)
        run: |
          # 验证预构建二进制文件是否有效 (检查 gzip 头 1f8b)
          test_prebuild() {
            local url=$1
            local header=$(curl -s --connect-timeout 5 --max-time 10 -r 0-1 "$url" | xxd -p)
            if [ "$header" = "1f8b" ]; then
              echo "valid"
            else
              echo "invalid"
            fi
          }
          
          # 验证华为云 better-sqlite3 预构建二进制 (macOS arm64)
          HUAWEI_PREBUILD=$(test_prebuild "https://repo.huaweicloud.com/better-sqlite3/v9.6.0/better-sqlite3-v9.6.0-electron-v119-darwin-arm64.tar.gz")
          echo "Huawei prebuild: $HUAWEI_PREBUILD"
          
          if [ "$HUAWEI_PREBUILD" = "valid" ]; then
            echo "Using Huawei mirror (prebuild valid)"
            npm config set registry https://repo.huaweicloud.com/repository/npm/
            pnpm config set registry https://repo.huaweicloud.com/repository/npm/
            echo "ELECTRON_MIRROR=https://repo.huaweicloud.com/electron/" >> $GITHUB_ENV
            echo "ELECTRON_BUILDER_BINARIES_MIRROR=https://repo.huaweicloud.com/electron-builder-binaries/" >> $GITHUB_ENV
          else
            echo "Huawei prebuild invalid, fallback to official npm registry"
            npm config set registry https://registry.npmjs.org/
            pnpm config set registry https://registry.npmjs.org/
          fi

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          npm_config_build_from_source: false

      - name: Build shared package
        run: pnpm --filter @cyp-memo/shared build || echo "Shared package has no build script, skipping"

      - name: Generate placeholder icons
        run: node scripts/create-placeholder-icons.mjs
        working-directory: packages/desktop

      - name: Build desktop app
        run: pnpm --filter @cyp-memo/desktop build:mac -- --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: List build output
        run: ls -la packages/desktop/release/*/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos
          path: |
            packages/desktop/release/**/*.dmg
            packages/desktop/release/**/*.zip
            packages/desktop/release/**/latest-mac.yml

  # ========== 构建桌面端 (Linux) ==========
  build-desktop-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev rpm

      - name: Cache pnpm & native builds
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
            ~/.cache/node-gyp
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-pnpm-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-electron-
            ${{ runner.os }}-pnpm-

      - name: Configure npm registry (优先华为云镜像，验证预构建二进制)
        run: |
          # 验证预构建二进制文件是否有效 (检查 gzip 头 1f8b)
          test_prebuild() {
            local url=$1
            local header=$(curl -s --connect-timeout 5 --max-time 10 -r 0-1 "$url" | xxd -p)
            if [ "$header" = "1f8b" ]; then
              echo "valid"
            else
              echo "invalid"
            fi
          }
          
          # 验证华为云 better-sqlite3 预构建二进制 (Linux x64)
          HUAWEI_PREBUILD=$(test_prebuild "https://repo.huaweicloud.com/better-sqlite3/v9.6.0/better-sqlite3-v9.6.0-electron-v119-linux-x64.tar.gz")
          echo "Huawei prebuild: $HUAWEI_PREBUILD"
          
          if [ "$HUAWEI_PREBUILD" = "valid" ]; then
            echo "Using Huawei mirror (prebuild valid)"
            npm config set registry https://repo.huaweicloud.com/repository/npm/
            pnpm config set registry https://repo.huaweicloud.com/repository/npm/
            echo "ELECTRON_MIRROR=https://repo.huaweicloud.com/electron/" >> $GITHUB_ENV
            echo "ELECTRON_BUILDER_BINARIES_MIRROR=https://repo.huaweicloud.com/electron-builder-binaries/" >> $GITHUB_ENV
          else
            echo "Huawei prebuild invalid, fallback to official npm registry"
            npm config set registry https://registry.npmjs.org/
            pnpm config set registry https://registry.npmjs.org/
          fi

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          npm_config_build_from_source: false

      - name: Build shared package
        run: pnpm --filter @cyp-memo/shared build || echo "Shared package has no build script, skipping"

      - name: Generate placeholder icons
        run: node scripts/create-placeholder-icons.mjs
        working-directory: packages/desktop

      - name: Build desktop app
        run: pnpm --filter @cyp-memo/desktop build:linux -- --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build output
        run: ls -la packages/desktop/release/*/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          path: |
            packages/desktop/release/**/*.AppImage
            packages/desktop/release/**/*.deb
            packages/desktop/release/**/*.rpm
            packages/desktop/release/**/*.tar.gz
            packages/desktop/release/**/latest-linux.yml


  # ========== 构建 Docker 镜像 (AMD64) ==========
  build-docker-amd64:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push AMD64
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}:${{ steps.version.outputs.VERSION }}-amd64
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,mode=max,scope=amd64
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
          provenance: false
          sbom: false

  # ========== 构建 Docker 镜像 (ARM64 原生) ==========
  build-docker-arm64:
    runs-on: ubuntu-24.04-arm  # GitHub 原生 ARM64 runner
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push ARM64
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}:${{ steps.version.outputs.VERSION }}-arm64
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
          provenance: false
          sbom: false

  # ========== 创建多架构 Docker 清单 ==========
  create-docker-manifest:
    needs: [build-docker-amd64, build-docker-arm64]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Create and push manifest (Alibaba Cloud ACR)
        run: |
          VERSION=${{ needs.build-docker-amd64.outputs.version }}
          ACR_REGISTRY=${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE=${{ secrets.ACR_NAMESPACE }}
          
          # 创建多架构清单
          docker buildx imagetools create \
            -t ${ACR_REGISTRY}/${ACR_NAMESPACE}:${VERSION} \
            -t ${ACR_REGISTRY}/${ACR_NAMESPACE}:latest \
            ${ACR_REGISTRY}/${ACR_NAMESPACE}:${VERSION}-amd64 \
            ${ACR_REGISTRY}/${ACR_NAMESPACE}:${VERSION}-arm64

  # ========== 发布 GitHub Release ==========
  publish-release:
    needs: [build-web, build-desktop-windows, build-desktop-macos, build-desktop-linux, create-docker-manifest]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.inputs.publish == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: Prepare release files
        run: |
          mkdir -p final-release
          # 复制所有文件到 final-release，保持扁平结构
          find release -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" -o -name "*.yml" \) -exec cp {} final-release/ \;
          ls -la final-release/

      - name: Extract version for release notes
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for current version
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          # 提取当前版本的更新日志（从 ## [版本号] 到下一个 ## 或 --- 之间的内容）
          CHANGELOG=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[|^---/{flag=0} flag" CHANGELOG.md | head -50)
          # 处理多行内容
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: final-release/*
          generate_release_notes: false
          body: |
            ## CYP-memo v${{ steps.version.outputs.VERSION }}
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            ### 下载
            
            #### 桌面客户端
            | 平台 | 下载 | 说明 |
            |------|------|------|
            | Windows | `CYP-memo-*-setup.exe` | NSIS 安装程序 |
            | Windows | `CYP-memo-*-portable.exe` | 便携版，无需安装 |
            | macOS | `CYP-memo-*-universal.dmg` | 支持 Intel 和 Apple Silicon |
            | Linux | `CYP-memo-*.AppImage` | 通用 Linux 格式 |
            | Linux (Debian/Ubuntu) | `cyp-memo_*.deb` | Debian 包 |
            
            #### Web 端
            - `cyp-memo-web-*.zip` - 用户端静态文件
            - `cyp-memo-admin-*.zip` - 管理端静态文件
            
            #### Docker (阿里云 ACR)
            ```bash
            docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}:${{ steps.version.outputs.VERSION }}
            ```
            
            ### 自动更新
            
            桌面客户端支持自动更新。如果您已安装旧版本，应用会自动检测并提示更新。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
