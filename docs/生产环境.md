# 生产环境问题追踪

本文档记录生产环境中发现的问题及其修复状态。

## 已修复问题 (v1.8.7)

### 1. 备忘录修改失败 (404错误)
- **问题**: 备忘录创建成功，但第二次修改失败，提示 404 Not Found，错误来自 createMemoHistory API
- **原因**: 服务器端缺少 `/api/memo-history` POST 路由
- **修复**: 
  - 在 `packages/server/src/sqlite-database.ts` 添加 `memo_history` 数据库表
  - 添加 `createMemoHistory`、`getMemoHistory`、`deleteMemoHistory` 方法
  - 在 `packages/server/src/index.ts` 添加备忘录历史API路由 (POST/GET/DELETE)
- **状态**: 已修复

### 2. 分享链接复制失败
- **问题**: 分享链接创建成功，但复制链接失败，提示 `Cannot read properties of undefined (reading 'writeText')`
- **原因**: `navigator.clipboard` API 在非安全上下文(HTTP)中不可用
- **修复**: 在 `packages/shared/src/managers/ShareManager.ts` 中:
  - 添加 `navigator.clipboard` 可用性检测
  - 添加 `document.execCommand('copy')` 回退方案
  - 支持两种复制方式，确保在HTTP环境下也能正常工作
- **状态**: 已修复

### 3. 分享访问次数显示为0
- **问题**: 访问分享链接多次后，访问次数仍显示为0
- **原因**: 服务器端 `updateShare` 方法未实现，PATCH `/api/shares/:id` 路由未真正更新数据
- **修复**: 
  - 在 `packages/server/src/sqlite-database.ts` 添加 `updateShare`、`getShareById`、`getShareByCode` 方法
  - 修复 `packages/server/src/index.ts` 中 PATCH `/api/shares/:id` 路由，正确调用 `database.updateShare()`
- **状态**: 已修复

### 4. 容器中版本更新提示
- **问题**: Docker容器中点击"立即更新"无法更新
- **说明**: 这是预期行为，Docker容器需要通过拉取新镜像来更新，无法像桌面端那样自动更新
- **处理**: 系统已有Docker环境检测功能:
  - 检测到Docker环境时显示"查看更新方法"按钮
  - 提供Watchtower自动更新和手动更新两种方式
  - 支持Docker Hub、GHCR、阿里云三个镜像源
- **状态**: 已处理（预期行为）

### 5. 数据导入后不刷新
- **问题**: 导入备忘录数据后，列表不会立即刷新，需要重新登录
- **原因**: 导入成功后未触发UI刷新
- **修复**: 在 `packages/app/src/views/MemoDataView.vue` 的 `confirmImport` 函数中:
  - 导入成功后调用 `loadMemoStats()` 刷新统计信息
  - 调用 `memoStore.loadMemos()` 刷新全局备忘录列表
- **状态**: 已修复

### 6. 备忘录列表显示遮挡
- **问题**: 备忘录列表中标题和内容显示不完整，被遮挡
- **原因**: CSS样式中缺少溢出处理和最大宽度限制
- **修复**: 在 `packages/app/src/views/memo/MemoListView.vue` 中优化CSS样式:
  - `.memo-title`: 添加 `max-width: calc(100% - 80px)` 防止被操作按钮遮挡
  - `.memo-content`: 添加 `word-break: break-word` 和 `min-height: 0` 确保正确换行
  - `.memo-card`: 添加 `overflow: hidden` 防止内容溢出
  - `.memo-tags`: 添加 `overflow: hidden` 和 `max-width: 60%` 限制标签区域
- **状态**: 已修复

### 7-8. PDF导出乱码
- **问题**: 导出PDF文件时中文显示为乱码或特殊字符
- **原因**: jsPDF默认字体(helvetica)不支持中文字符
- **修复**: 在 `packages/app/src/views/MemoDataView.vue` 中重写 `exportToPDF` 函数:
  - 使用英文表头 (No., Title, Content, Tags, Priority, Created)
  - 使用 `stripHtmlTags` 函数清理HTML标签
  - 优化表格布局和列宽
  - 添加 `didParseCell` 回调确保文本正确处理
- **状态**: 已修复（中文内容可能显示为方块，建议使用Excel导出保留中文）

### 9. Excel导出包含HTML标签
- **问题**: 导出Excel文件时，内容列包含 `<p>` 等HTML标签
- **原因**: 导出时未清理HTML标签
- **修复**: 在 `packages/app/src/views/MemoDataView.vue` 中:
  - 添加 `stripHtmlTags` 函数，移除所有HTML标签并解码HTML实体
  - 在 `exportToExcel` 函数中使用 `stripHtmlTags(memo.content)` 清理内容
- **状态**: 已修复

## 版本信息

- **修复版本**: v1.8.7
- **修复日期**: 2026-01-12
- **修复文件**:
  - `packages/server/src/index.ts`
  - `packages/server/src/sqlite-database.ts`
  - `packages/shared/src/managers/ShareManager.ts`
  - `packages/app/src/views/MemoDataView.vue`
  - `packages/app/src/views/memo/MemoListView.vue`
