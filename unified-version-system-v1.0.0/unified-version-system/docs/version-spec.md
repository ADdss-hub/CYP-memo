# 通用版本规范

**基于**: 语义化版本控制规范 (SemVer 2.0.0)  
**参考**: https://semver.org/spec/v2.0.0

---

## 版本格式

采用语义化版本控制规范 (SemVer 2.0.0)，版本号格式为 `MAJOR.MINOR.PATCH`：

- **MAJOR** (主版本号): 当你做了不兼容的 API 修改时递增
- **MINOR** (次版本号): 当你以向后兼容的方式添加功能时递增
- **PATCH** (修订号): 当你做了向后兼容的问题修正时递增

### 扩展标签

预发布和构建元数据可作为扩展标签：

- **预发布版本**: `-alpha`, `-beta`, `-rc.N`
  - 格式: `MAJOR.MINOR.PATCH-prerelease`
  - 示例: `1.0.0-alpha`, `1.0.0-beta.1`, `1.0.0-rc.2`

- **构建元数据**: `+build`
  - 格式: `MAJOR.MINOR.PATCH+buildmetadata`
  - 示例: `1.0.0+20130313144700`, `1.0.0-beta+exp.sha.5114f85`

### 完整格式示例

```
1.0.0                    # 正式版本
1.0.0-alpha              # Alpha 预发布版本
1.0.0-alpha.1            # Alpha 预发布版本（带编号）
1.0.0-beta.2             # Beta 预发布版本
1.0.0-rc.1               # Release Candidate
1.0.0+20130313144700     # 带构建元数据
1.0.0-beta+exp.sha.5114f85  # 预发布版本带构建元数据
```

---

## 版本号格式规范（SemVer 2.0.0）

### 必须遵守的规则（MUST）

1. **版本号格式**
   - 正常版本号**必须**采用 X.Y.Z 的形式
   - X、Y 和 Z 为**非负整数**
   - **禁止**包含前导零
   - 每个元素**必须**以数值递增
   - 示例: 1.9.0 -> 1.10.0 -> 1.11.0

2. **版本不可变性**
   - 一旦版本化的包已经发布，该版本的内容**禁止**被修改
   - 任何修改**必须**作为新版本发布

3. **修订号递增**（x.y.Z | x > 0）
   - **必须**在仅引入向后兼容的错误修复时递增
   - 错误修复定义为修正不正确行为的内部更改

4. **次版本号递增**（x.Y.z | x > 0）
   - **必须**在向公共 API 引入新的向后兼容功能时递增
   - **必须**在任何公共 API 功能被标记为弃用时递增
   - 当次版本号递增时，修订号**必须**重置为 0

5. **主版本号递增**（X.y.z | X > 0）
   - **必须**在向公共 API 引入任何向后不兼容的更改时递增
   - 当主版本号递增时，次版本号和修订号**必须**重置为 0

6. **预发布版本**
   - 标识符**必须**仅包含 ASCII 字母数字和连字符 [0-9A-Za-z-]
   - 标识符**禁止**为空
   - 数字标识符**禁止**包含前导零
   - 预发布版本的优先级低于关联的正常版本

7. **构建元数据**
   - 标识符**必须**仅包含 ASCII 字母数字和连字符 [0-9A-Za-z-]
   - 标识符**禁止**为空
   - 在确定版本优先级时**必须**忽略构建元数据

### 应该遵守的规则（SHOULD）

1. **公共 API 声明**
   - 使用语义化版本控制的软件**应该**声明公共 API
   - API **应该**是精确和全面的

2. **初始开发阶段**
   - 主版本号为零（0.y.z）用于初始开发
   - 公共 API **不应该**被视为稳定

### 可以选择的规则（MAY）

1. **次版本号递增**
   - **可以**在私有代码中引入大量新功能或改进时递增
   - **可以**包含修订级别的更改

2. **主版本号递增**
   - **可以**包含次版本号和修订号级别的更改

3. **预发布版本**
   - **可以**通过在修订号后附加连字符和标识符来表示

4. **构建元数据**
   - **可以**通过在修订号或预发布版本后附加加号和标识符来表示

---

## 版本号数字规范

### 基本要求（必须遵守）

根据 SemVer 2.0.0 规范：

1. ✅ 版本号**必须**是**非负整数**（≥ 0）
2. ✅ **禁止**使用前导零（例如：01.02.03 是无效的）
3. ✅ 版本号**必须**单调递增
4. ✅ 每个元素必须以数值递增

### 实践建议（推荐遵守）

为了保持版本号的可读性和语义化，建议：

- **MAJOR**: 0-99（大多数项目不会超过 10）
- **MINOR**: 0-99（建议不超过 50）
- **PATCH**: 0-99（建议不超过 20）

**理由**：
- 保持版本号简洁易读
- 符合大多数项目的实际需求
- 避免版本号过大导致的问题

### 技术限制（硬性限制）

为了确保在所有系统中都能正确处理：

- **MAJOR**: 0-999
- **MINOR**: 0-9999
- **PATCH**: 0-9999

**理由**：
- 确保在所有系统中都能正确处理
- 避免超过数据库整数范围
- 保持与现有工具的兼容性

### 警告阈值

当版本号达到以下阈值时，系统会发出警告：

- **PATCH > 20**: 建议递增 MINOR 版本号
- **MINOR > 50**: 建议递增 MAJOR 版本号
- **MAJOR > 10**: 项目可能需要重大重构

### 示例

#### 有效且合理的版本号
- ✅ `1.0.0` - 标准版本
- ✅ `1.9.1` - 当前项目版本
- ✅ `2.0.0` - 主版本递增
- ✅ `1.10.0` - 次版本递增（注意：10 不是 01）
- ✅ `1.0.0-alpha` - 预发布版本
- ✅ `1.0.0-beta.1` - 带编号的预发布版本
- ✅ `1.0.0+20130313144700` - 带构建元数据

#### 有效但需要注意的版本号
- ⚠️  `1.100.0` - 有效但次版本号较大，建议递增主版本号
- ⚠️  `1.5.63` - 有效但修订号过大，应递增次版本号

#### 无效的版本号
- ❌ `1.01.0` - 无效（有前导零）
- ❌ `01.2.3` - 无效（有前导零）
- ❌ `1.-1.0` - 无效（负数）
- ❌ `1.2` - 无效（缺少修订号）
- ❌ `v1.2.3` - 无效（SemVer 不包含 "v" 前缀）
- ❌ `1.10000.0` - 无效（超过技术限制）

**注意**: "v1.2.3" 不是语义化版本，但在版本控制中常用 "v" 前缀表示标签名称，语义化版本本身是 "1.2.3"。

---

## 版本变更规则

### PATCH 版本号递增（修订号）

**适用场景**：
- ✅ 向后兼容的缺陷修复
- ✅ 内部优化和重构（不影响公共 API）
- ✅ 文档更新
- ✅ 代码风格调整（不影响功能）
- ✅ 性能优化（不改变 API）

**示例**: v1.9.0 → v1.9.1

### MINOR 版本号递增（次版本号）

**必须递增的场景**：
- ✅ 向公共 API 引入新的向后兼容功能
- ✅ 任何公共 API 功能被标记为弃用

**可以递增的场景**：
- ✅ 在私有代码中引入大量新功能或改进
- ✅ 包含修订级别的更改

**规则**: 当次版本号递增时，修订号必须重置为 0

**示例**: v1.9.1 → v1.10.0

### MAJOR 版本号递增（主版本号）

**必须递增的场景**：
- ✅ 向公共 API 引入任何向后不兼容的更改
- ✅ 删除公共 API 功能
- ✅ 重大架构调整（破坏兼容性）

**可以包含**：
- ✅ 次版本号和修订号级别的更改

**规则**: 当主版本号递增时，次版本号和修订号必须重置为 0

**示例**: v1.10.0 → v2.0.0

---

## 版本优先级

版本优先级规则（按 SemVer 2.0.0 规范）：

1. **数值比较**: 主版本号、次版本号和修订号以数值方式比较
   - 1.0.0 < 2.0.0 < 2.1.0 < 2.1.1

2. **预发布版本**: 预发布版本的优先级低于正常版本
   - 1.0.0-alpha < 1.0.0

3. **预发布版本比较**: 从左到右比较每个标识符
   - 仅数字: 数值比较
   - 包含字母: 词法比较（ASCII 排序）
   - 数字标识符优先级低于非数字标识符
   - 示例: 1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-alpha.beta < 1.0.0-beta < 1.0.0-beta.2 < 1.0.0-beta.11 < 1.0.0-rc.1 < 1.0.0

4. **构建元数据**: 在确定版本优先级时被忽略
   - 1.0.0+001 = 1.0.0+002（优先级相同）

---

## 版本发布原则

### 基本原则

1. ✅ 稳定版本不能跟随预发布版本
2. ✅ 预发布版本可以跟随稳定版本
3. ✅ 版本号必须是数字（预发布标识符除外）
4. ✅ 版本号递增必须是单调递增的
5. ✅ 版本号应保持在合理范围内
6. ✅ 一旦发布，版本内容不可修改

### 初始开发阶段（0.y.z）

- 主版本号为零用于初始开发
- 任何内容可以随时更改
- 公共 API 不应被视为稳定
- 建议从 0.1.0 开始，为每个后续版本递增次版本号

### 1.0.0 发布时机

以下情况应该发布 1.0.0：
- 软件在生产环境中使用
- 有一个用户已经依赖的稳定 API
- 非常担心向后兼容性

---

## 版本号数字限制

虽然 SemVer 2.0.0 规范没有明确规定版本号数字的上限，但为了保持版本号的可读性和语义化，本项目**必须**遵循以下限制：

### 强制限制（MUST）

为了保持版本号的可读性和语义化，版本号各部分**必须**遵循以下限制：

- **MAJOR**: 0-99（强制限制）
- **MINOR**: 0-50（强制限制）
- **PATCH**: 0-30（强制限制）

**限制说明**：
- 当 PATCH 达到 30 时，**必须**递增 MINOR 版本号并将 PATCH 重置为 0
- 当 MINOR 达到 50 时，**必须**递增 MAJOR 版本号并将 MINOR 和 PATCH 重置为 0
- 当 MAJOR 达到 99 时，**应该**重新评估项目的版本策略

**限制原因**：
1. **可读性**：较小的数字更容易记忆和识别
2. **语义化**：频繁的版本递增表明项目活跃，但过大的数字失去语义
3. **最佳实践**：遵循业界主流项目的版本号管理习惯
4. **版本规划**：强制限制促使团队更好地规划版本发布

### 警告阈值（SHOULD）

当版本号超过以下阈值时，系统**应该**发出警告：

- **PATCH > 20**: 建议尽快递增 MINOR 版本号
- **MINOR > 40**: 建议尽快递增 MAJOR 版本号
- **MAJOR > 50**: 建议重新评估版本策略

### 版本号限制示例

**符合强制限制的版本号**：
- `v1.0.0` ✅
- `v10.25.15` ✅
- `v99.50.30` ✅（达到上限）
- `v2.15.8` ✅

**超出强制限制的版本号**：
- `v100.0.0` ❌（MAJOR 超过 99）
- `v1.51.0` ❌（MINOR 超过 50）
- `v1.0.31` ❌（PATCH 超过 30）
- `v1.60.40` ❌（MINOR 和 PATCH 都超过限制）

---

## 常见问题

### 1. 如何处理弃用功能？

1. 更新文档让用户知道更改
2. 发布一个包含弃用的新次版本
3. 在新的主版本中完全删除功能之前，至少有一个包含弃用的次版本

### 2. 如果不小心将不兼容更改作为次版本发布了怎么办？

1. 修复问题
2. 发布一个新的次版本，纠正问题并恢复向后兼容性
3. 记录有问题的版本并通知用户

### 3. 更新依赖项但不更改公共 API 应该怎么做？

- 修复错误 → PATCH 递增
- 引入新功能 → MINOR 递增

---

## 正则表达式

### JavaScript/Node.js 版本验证

```javascript
const SEMVER_REGEX = /^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/;

// 使用示例
const version = "1.0.0-alpha.1+build.123";
const match = version.match(SEMVER_REGEX);

if (match) {
  const [, major, minor, patch, prerelease, buildmetadata] = match;
  console.log({ major, minor, patch, prerelease, buildmetadata });
}
```

---

## 参考资源

- **SemVer 官方规范**: https://semver.org/spec/v2.0.0
- **SemVer 中文版**: https://semver.org/lang/zh-CN/
- **约定式提交**: https://www.conventionalcommits.org/
- **Keep a Changelog**: https://keepachangelog.com/

---

**文档版本**: 2.0.0  
**最后更新**: 2025年12月28日  
**维护者**: CYP 版本管理系统
