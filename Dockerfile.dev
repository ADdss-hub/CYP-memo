# CYP-memo 开发模式 Dockerfile
# 支持热重载和调试功能

FROM node:18-alpine

# 安装 pnpm
RUN npm install -g pnpm

# 创建工作目录
WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/app/package.json ./packages/app/
COPY packages/admin/package.json ./packages/admin/
COPY packages/server/package.json ./packages/server/

# 安装全部依赖（包括开发依赖）
RUN pnpm install --frozen-lockfile

# 复制源代码（开发模式下会被挂载覆盖）
COPY . .

# 创建数据目录
RUN mkdir -p /app/data

# 环境变量
ENV NODE_ENV=development \
    PORT=5170 \
    DATA_DIR=/app/data \
    LOG_LEVEL=debug

# 暴露端口
# 5170: 应用端口
# 9229: Node.js 调试端口
EXPOSE 5170 9229

# 设置工作目录到服务器包
WORKDIR /app

# 默认命令：启动开发服务器（支持热重载）
CMD ["pnpm", "dev:server"]
