# CYP-memo 完整文档

> 作者: CYP | 邮箱: nasDSSCYP@outlook.com

---

## 目录

1. [项目概述](#项目概述)
2. [快速开始](#快速开始)
3. [功能详解](#功能详解)
4. [技术架构](#技术架构)
5. [数据模型](#数据模型)
6. [API 接口](#api-接口)
7. [开发指南](#开发指南)
8. [部署指南](#部署指南)
9. [常见问题](#常见问题)

---

## 项目概述

CYP-memo 是一款现代化的容器备忘录管理系统，采用前后端分离架构，提供完整的中文界面。

### 系统组成

| 组件 | 端口 | 说明 |
|------|------|------|
| 用户端 | 5173 | 普通用户使用的 Web 应用 |
| 管理端 | 5174 | 系统管理员使用的 Web 应用 |
| API 服务器 | 5170 | RESTful API 服务，SQLite 数据库 |

### 核心特性

- **双重认证**: 账号密码 + 个人令牌
- **富文本编辑**: 基于 TipTap，支持 Markdown
- **文件管理**: 附件上传下载，最大 10GB
- **权限管理**: 主账号/子账号体系
- **数据共享**: 主账号与子账号备忘录共享
- **分享功能**: 生成分享链接，支持密码保护
- **深色主题**: 浅色/深色主题切换
- **高性能**: SQLite 数据库，性能提升 10-100 倍

---

## 快速开始

### 环境要求

- Node.js >= 18.0.0
- pnpm >= 8.0.0

### 安装步骤

```bash
# 1. 克隆项目
git clone <repository-url>
cd cyp-memo

# 2. 安装依赖
pnpm install

# 3. 启动服务
pnpm dev
# 或 Windows: dev.bat
```

### 访问应用

- 用户端: http://localhost:5173
- 管理端: http://localhost:5174

### 默认管理员

```
用户名: admin
密码: admin123
```

---

## 功能详解

### 1. 用户认证系统

#### 认证方式

| 方式 | 说明 |
|------|------|
| 账号密码 | 传统用户名密码认证 |
| 个人令牌 | 64位十六进制令牌认证 |

#### 注册流程

1. 填写用户名、密码、安全问题
2. 系统自动生成个人令牌
3. 注册成功页面显示令牌
4. 用户复制保存令牌

#### 安全功能

- 安全问题设置与验证
- 密码找回（通过令牌或安全问题）
- 账号找回功能
- PBKDF2 密码哈希

### 2. 账号体系

#### 主账号

- 拥有完整权限
- 可创建和管理子账号
- 可查看所有子账号的备忘录

#### 子账号

- 由主账号创建
- 权限受限（由主账号分配）
- 可查看同一主账号下的所有备忘录
- 不同主账号之间数据完全隔离

#### 权限列表

| 权限标识 | 说明 |
|----------|------|
| memo_manage | 备忘录管理 |
| statistics_view | 数据统计查看 |
| attachment_manage | 附件管理 |
| settings_manage | 系统设置 |
| account_manage | 账号管理 |

### 3. 备忘录管理

#### 基本功能

- 创建、编辑、删除备忘录
- 富文本编辑（支持 Markdown）
- 标签分类系统
- 优先级设置（低/中/高）

#### 搜索与排序

- 全文搜索
- 按更新时间排序
- 按创建时间排序
- 按标题排序

#### 数据共享

- 主账号可查看所有子账号的备忘录
- 子账号可查看同一主账号下的所有备忘录
- 备忘录显示创建人信息

### 4. 文件附件管理

- 文件上传与下载
- 附件与备忘录关联
- 存储空间统计
- 支持多种文件格式
- 孤立文件清理

### 5. 分享功能

- 生成分享链接
- 可选密码保护
- 可设置过期时间
- 访问次数统计
- 分享链接管理

### 6. 数据管理

#### 导入导出

| 格式 | 导入 | 导出 |
|------|------|------|
| JSON | ✓ | ✓ |
| Excel | ✓ | ✓ |
| PDF | - | ✓ |

#### 数据清理

- 已删除备忘录清理
- 孤立文件清理
- 过期分享链接清理
- 旧日志清理

### 7. 系统设置

- 主题切换（浅色/深色）
- 字体大小调整（小/中/大）
- 语言设置
- 自动清理配置
- 欢迎引导重置

### 8. 管理端功能

- 用户管理（查看、删除）
- 数据库管理（统计、清空）
- 系统监控（日志查看、筛选）
- 管理员账号管理

---

## 技术架构

### 技术栈

| 类别 | 技术 |
|------|------|
| 前端框架 | Vue 3 + TypeScript |
| UI 组件库 | Element Plus |
| 富文本编辑器 | TipTap |
| 状态管理 | Pinia |
| 路由 | Vue Router |
| 后端框架 | Express.js |
| 数据库 | SQLite |
| 构建工具 | Vite |
| 测试框架 | Vitest + fast-check |
| 包管理 | pnpm (Monorepo) |

### 项目结构

```
cyp-memo/
├── packages/
│   ├── shared/          # 共享库
│   │   ├── config/      # 配置（版本信息）
│   │   ├── database/    # 数据访问层 (DAO)
│   │   │   ├── UserDAO.ts
│   │   │   ├── MemoDAO.ts
│   │   │   ├── FileDAO.ts
│   │   │   ├── LogDAO.ts
│   │   │   └── AdminDAO.ts
│   │   ├── managers/    # 业务逻辑管理器
│   │   │   ├── AuthManager.ts
│   │   │   ├── MemoManager.ts
│   │   │   ├── FileManager.ts
│   │   │   ├── ShareManager.ts
│   │   │   ├── DataManager.ts
│   │   │   ├── LogManager.ts
│   │   │   ├── PermissionManager.ts
│   │   │   ├── CleanupManager.ts
│   │   │   ├── WelcomeManager.ts
│   │   │   └── InitManager.ts
│   │   ├── storage/     # 存储适配器
│   │   │   ├── StorageAdapter.ts
│   │   │   ├── StorageManager.ts
│   │   │   ├── RemoteStorageAdapter.ts
│   │   │   └── LocalStorageAdapter.ts
│   │   ├── types/       # TypeScript 类型定义
│   │   ├── utils/       # 工具函数
│   │   └── workers/     # Web Workers
│   ├── app/             # 用户端应用
│   │   ├── src/
│   │   │   ├── components/  # Vue 组件
│   │   │   ├── views/       # 页面视图
│   │   │   ├── stores/      # Pinia 状态
│   │   │   ├── router/      # 路由配置
│   │   │   └── composables/ # 组合式函数
│   │   └── tests/
│   ├── admin/           # 管理端应用
│   │   └── src/
│   └── server/          # API 服务器
│       └── src/
│           ├── index.ts
│           └── sqlite-database.ts
├── scripts/             # 构建脚本
├── docs/                # 详细文档
└── .version/            # 版本历史
```

### 存储架构

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (App/Admin)                    │
│                  Vue Components & Stores                 │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                    管理器层 (Managers)                   │
│  AuthManager, MemoManager, DataManager, ShareManager... │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                    DAO 层 (Data Access)                  │
│      UserDAO, MemoDAO, FileDAO, LogDAO, AdminDAO        │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              存储适配器 (RemoteStorageAdapter)           │
└────────────────────┬────────────────────────────────────┘
                     │ REST API
┌────────────────────▼────────────────────────────────────┐
│                 API 服务器 (Express.js)                  │
│                   SQLite 数据库                          │
└─────────────────────────────────────────────────────────┘
```

---

## 数据模型

### 用户 (User)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识 |
| username | string | 用户名 |
| passwordHash | string | 密码哈希 |
| token | string | 个人令牌 |
| securityQuestion | object | 安全问题 |
| gender | string | 性别 |
| email | string | 邮箱 |
| birthDate | Date | 出生日期 |
| phone | string | 电话 |
| address | string | 地址 |
| position | string | 职位 |
| company | string | 公司 |
| bio | string | 个人简介 |
| isMainAccount | boolean | 是否主账号 |
| parentUserId | string | 父账号ID |
| permissions | array | 权限列表 |
| createdAt | Date | 创建时间 |
| lastLoginAt | Date | 最后登录 |

### 备忘录 (Memo)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识 |
| userId | string | 所属用户 |
| title | string | 标题 |
| content | string | 内容 |
| tags | array | 标签列表 |
| priority | string | 优先级 (low/medium/high) |
| attachments | array | 附件ID列表 |
| creatorName | string | 创建人用户名 |
| createdAt | Date | 创建时间 |
| updatedAt | Date | 更新时间 |
| deletedAt | Date | 删除时间 |

### 文件 (FileMetadata)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识 |
| userId | string | 所属用户 |
| filename | string | 文件名 |
| size | number | 文件大小 |
| type | string | MIME 类型 |
| memoId | string | 关联备忘录 |
| uploadedAt | Date | 上传时间 |

### 分享链接 (ShareLink)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识 |
| memoId | string | 备忘录ID |
| userId | string | 创建者ID |
| password | string | 访问密码 |
| expiresAt | Date | 过期时间 |
| accessCount | number | 访问次数 |
| createdAt | Date | 创建时间 |

### 日志 (LogEntry)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识 |
| level | string | 级别 (debug/info/warn/error) |
| message | string | 消息内容 |
| context | object | 上下文信息 |
| timestamp | Date | 时间戳 |

---

## API 接口

### 用户相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/users | 创建用户 |
| GET | /api/users/:id | 获取用户 |
| GET | /api/users/username/:username | 按用户名查询 |
| GET | /api/users/token/:token | 按令牌查询 |
| PATCH | /api/users/:id | 更新用户 |
| DELETE | /api/users/:id | 删除用户 |
| GET | /api/users/:id/sub-accounts | 获取子账号列表 |

### 备忘录相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/memos | 创建备忘录 |
| GET | /api/memos/:id | 获取备忘录 |
| GET | /api/users/:userId/memos | 获取用户备忘录 |
| PATCH | /api/memos/:id | 更新备忘录 |
| DELETE | /api/memos/:id | 删除备忘录 |

### 文件相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/files | 上传文件 |
| GET | /api/files/:id/metadata | 获取文件元数据 |
| GET | /api/files/:id/blob | 下载文件 |
| DELETE | /api/files/:id | 删除文件 |
| GET | /api/users/:userId/files | 获取用户文件 |
| GET | /api/users/:userId/storage | 获取存储统计 |

### 分享相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/shares | 创建分享 |
| GET | /api/shares/:id | 获取分享 |
| DELETE | /api/shares/:id | 删除分享 |
| GET | /api/users/:userId/shares | 获取用户分享 |

### 日志相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/logs | 创建日志 |
| GET | /api/logs | 获取日志列表 |
| GET | /api/logs/by-level/:level | 按级别筛选 |
| DELETE | /api/logs | 清空日志 |

### 管理相关

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/health | 健康检查 |
| DELETE | /api/data/clear | 清空数据库 |
| POST | /api/admins/login | 管理员登录 |

---

## 开发指南

### 开发命令

```bash
# 启动开发服务
pnpm dev

# 构建生产版本
pnpm build

# 运行测试
pnpm test

# 代码检查
pnpm lint

# 代码格式化
pnpm format
```

### 代码规范

- 使用 TypeScript 严格模式
- 使用 Vue 3 Composition API
- 单个文件不超过 500 行
- 所有源文件包含版权声明
- 使用 ESLint + Prettier

### 提交规范

```
feat: 新功能
fix: 修复 bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

### 测试策略

- **单元测试**: `*.test.ts`
- **属性测试**: `*.property.test.ts`
- 使用 Vitest + fast-check
- 每个属性测试至少 100 次迭代

---

## 部署指南

### Docker 部署（推荐）

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 传统部署

```bash
# 构建
pnpm build

# 启动服务器
cd packages/server
pnpm start
```

### PM2 部署

```bash
pm2 start packages/server/dist/index.js --name cyp-memo
pm2 startup
pm2 save
```

### Nginx 配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        root /path/to/packages/app/dist;
        try_files $uri $uri/ /index.html;
    }

    location /admin {
        root /path/to/packages/admin/dist;
        try_files $uri $uri/ /admin/index.html;
    }

    location /api {
        proxy_pass http://localhost:5170;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 环境变量

```bash
PORT=5170
NODE_ENV=production
DB_PATH=./data/database.sqlite
CORS_ORIGIN=http://localhost:5173,http://localhost:5174
```

### 数据备份

```bash
# 手动备份
cp packages/server/data/database.sqlite backup/

# 定时备份 (crontab)
0 2 * * * cp /path/to/database.sqlite /backup/database.$(date +\%Y\%m\%d).sqlite
```

---

## 常见问题

### Q: 如何清除本地数据？

打开浏览器开发工具 → Application → IndexedDB → 删除 CYPMemoDB

### Q: 如何重置欢迎引导？

在设置页面点击"重置引导"按钮

### Q: 如何查看系统日志？

管理端 → 系统监控 → 日志查看

### Q: 如何备份数据？

设置页面 → 数据导出，或直接备份 `database.sqlite` 文件

### Q: 端口被占用怎么办？

```bash
# Windows
netstat -ano | findstr :5170
taskkill /PID <PID> /F

# Linux/Mac
lsof -i :5170
kill -9 <PID>
```

### Q: 依赖安装失败？

```bash
pnpm store prune
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

---

## 版权信息

版权所有 © 2026 CYP

保留所有权利

许可证: MIT License

---

*最后更新: 2026-01-11*
