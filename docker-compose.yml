version: '3.8'

services:
  cyp-memo:
    build:
      context: .
      args:
        - VERSION=1.7.9
        - BUILD_DATE=${BUILD_DATE:-}
        - GIT_COMMIT=${GIT_COMMIT:-}
    image: cyp-memo:latest
    container_name: cyp-memo
    ports:
      - "5170:5170"
    volumes:
      - cyp-memo-data:/app/data
      # 只读文件系统模式下需要的临时目录
      - /tmp
    environment:
      - NODE_ENV=production
      - PORT=5170
      - DATA_DIR=/app/data
      - TZ=Asia/Shanghai
    restart: unless-stopped
    # 使用非 root 用户运行（在 Dockerfile 中配置）
    # user: "1001:1001"  # 可选：显式指定用户
    
    # 安全加固配置
    security_opt:
      - no-new-privileges:true  # 禁止进程获取新权限
    cap_drop:
      - ALL                      # 移除所有 Linux capabilities
    cap_add:
      - CHOWN                    # 允许修改文件所有者（数据目录初始化需要）
      - SETUID                   # 允许设置用户 ID（Node.js 运行需要）
      - SETGID                   # 允许设置组 ID（Node.js 运行需要）
    # 只读文件系统配置（可选，取消注释启用）
    # read_only: true            # 启用只读文件系统
    # tmpfs:
    #   - /tmp:size=64M          # 临时文件系统
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5170/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cyp-memo-network

networks:
  cyp-memo-network:
    driver: bridge

volumes:
  cyp-memo-data:
    driver: local
